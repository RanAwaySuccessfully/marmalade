name: Build Marmalade

on:
  workflow_dispatch:

jobs:

  marmalade-debian12:
    name: Build Marmalade
    runs-on: ubuntu-latest
    container: debian:bookworm
    defaults:
      run:
        shell: bash
    steps:
    
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        apt-get update
        apt-get install -y libv4l-dev libgtk-3-dev libgtk-4-dev libgirepository1.0-dev

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25'

    - uses: actions/checkout@v4
      with:
        repository: 'RanAwaySuccessfully/gotk4'
        ref: '4.8'
        path: 'gotk4'

    - name: Set up gotk4 replacement
      run: |
        mv gotk4 ../
        go work init
        printf "\nreplace github.com/diamondburned/gotk4/pkg => ../gotk4/pkg\n\nuse ." >> go.work

    - name: Build CMD version
      run: env CGO_ENABLED=0 go build -v
    
    - name: Build GTK 4 version
      run: go build -v -tags withgtk4 -o marmalade-gtk4

    - name: Build GTK 3 version
      run: go build -v -tags withgtk3 -o marmalade-gtk3

    - name: Create distributable folder
      run: |
        mkdir dist
        mv -t dist config.json LICENSE marmalade marmalade-gtk3 marmalade-gtk4

    - name: Export build
      uses: actions/upload-artifact@v4
      with:
        name: marmalade-dist
        path: dist
        if-no-files-found: error
        retention-days: 1
        compression-level: 1
        overwrite: true

  mediapipe:
    name: Build MediaPipe
    runs-on: ubuntu-22.04
    steps:
    
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.12'
        cache: 'pip'
        pip-install: pex opencv-contrib-python mediapipe

    - name: Build Python executable
      run: |
        cd python
        pex -v -r requirements.txt --scie eager -o dist/mediapipe
        cp LICENSE main.py compute_params.py dist/

    - name: Export build
      uses: actions/upload-artifact@v4
      with:
        name: mediapipe-dist
        path: python/dist
        if-no-files-found: error
        retention-days: 1
        compression-level: 1
        overwrite: true

  merge:
    needs:
    - marmalade-debian12
    - mediapipe
    name: Merge builds
    runs-on: ubuntu-latest
    steps:
    
    - name: Import Marmalade build
      uses: actions/download-artifact@v4
      with:
        name: marmalade-dist
        path: dist

    - name: Import MediaPipe build
      uses: actions/download-artifact@v4
      with:
        name: mediapipe-dist
        path: dist/python

    - name: Delete temporary builds
      uses: geekyeggo/delete-artifact@v5
      with:
          name: |
            marmalade-dist
            mediapipe-dist

    - name: Set executables as executable
      run: chmod +x dist/marmalade dist/marmalade-gtk3 dist/marmalade-gtk4 dist/python/mediapipe

    - name: Export complete build
      uses: actions/upload-artifact@v4
      with:
        name: marmalade
        path: dist
        if-no-files-found: error
        retention-days: 1
        compression-level: 1
        overwrite: true
